name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  DOTNET_VERSION: '9.0.x'

jobs:
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout PR code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        fetch-depth: 0
    
    - name: üîß Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: üìä PR Info
      run: |
        echo "## üìã Pull Request Information" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Title:** ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Author:** @${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** ${{ github.head_ref }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Base:** ${{ github.base_ref }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
    
    - name: üîç Changed Files
      id: changed-files
      uses: tj-actions/changed-files@v44
      with:
        files: |
          **.cs
          **.csproj
          **.json
    
    - name: üìù List Changed Files
      run: |
        echo "## üìù Changed Files" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "${{ steps.changed-files.outputs.all_changed_files }}" | tr ' ' '\n' | while read file; do
          echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
        done
    
    - name: üì¶ Restore dependencies
      run: dotnet restore
    
    - name: üî® Build
      run: dotnet build --no-restore --configuration Release
    
    - name: üß™ Quick Test
      run: |
        dotnet test Rest.Tests/Rest.Tests.csproj \
          --filter "FullyQualifiedName~UnitTests" \
          --configuration Release \
          --no-build \
          --logger "console;verbosity=normal"
    
    - name: ‚úÖ PR Ready
      if: success()
      run: |
        echo "## ‚úÖ PR Validation Passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "All checks passed. PR is ready for review!" >> $GITHUB_STEP_SUMMARY

  affected-tests:
    name: Run Affected Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: üîß Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: üì¶ Restore dependencies
      run: dotnet restore
    
    - name: üß™ Run Related Tests
      run: |
        # Run all tests for PRs to ensure nothing breaks
        dotnet test Rest.Tests/Rest.Tests.csproj \
          --configuration Release \
          --no-restore \
          --logger "trx;LogFileName=pr-test-results.trx" \
          --logger "console;verbosity=normal" \
          --results-directory ./TestResults \
          --collect:"XPlat Code Coverage"
    
    - name: üìä Test Results
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: PR Test Results
        path: 'TestResults/**/*.trx'
        reporter: dotnet-trx
        fail-on-error: false
        fail-on-empty: false
    
    - name: üìà Coverage Comparison
      uses: codecov/codecov-action@v4
      if: success() || failure()
      with:
        files: 'TestResults/**/coverage.opencover.xml'
        flags: pr-tests
        name: pr-coverage
      continue-on-error: true

  code-review-checks:
    name: Code Review Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: üîß Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: üì¶ Restore dependencies
      run: dotnet restore
    
    - name: üìã Check Code Format
      run: |
        dotnet format --verify-no-changes --verbosity diagnostic
      continue-on-error: true
    
    - name: üîç Static Code Analysis
      run: |
        dotnet build Rest/Rest.csproj \
          --configuration Release \
          --no-restore \
          /p:RunAnalyzers=true \
          /p:AnalysisLevel=latest \
          /p:TreatWarningsAsErrors=false
    
    - name: üìè Code Metrics
      run: |
        # Install metrics tool
        dotnet tool install -g dotnet-code-metrics
        
        # Generate metrics (if tool is available)
        echo "Code metrics analysis would run here"
      continue-on-error: true

  pr-label:
    name: Auto Label PR
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
    - name: üè∑Ô∏è Label PR
      uses: actions/labeler@v5
      with:
        repo-token: ${{ secrets.GITHUB_TOKEN }}

  size-label:
    name: PR Size Label
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    
    steps:
    - name: üìè PR Size
      uses: codelytv/pr-size-labeler@v1
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        xs_label: 'size/xs'
        xs_max_size: 10
        s_label: 'size/s'
        s_max_size: 100
        m_label: 'size/m'
        m_max_size: 500
        l_label: 'size/l'
        l_max_size: 1000
        xl_label: 'size/xl'

  comment-summary:
    name: Comment Test Summary
    needs: [pr-validation, affected-tests]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      pull-requests: write
    
    steps:
    - name: üí¨ Comment on PR
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.issue.number;
          const validationResult = '${{ needs.pr-validation.result }}';
          const testsResult = '${{ needs.affected-tests.result }}';
          
          const icon = (result) => {
            switch(result) {
              case 'success': return '‚úÖ';
              case 'failure': return '‚ùå';
              case 'cancelled': return '‚ö†Ô∏è';
              default: return '‚è≠Ô∏è';
            }
          };
          
          const message = `## ü§ñ Automated PR Checks
          
          ### Results Summary
          - ${icon(validationResult)} **Validation:** ${validationResult}
          - ${icon(testsResult)} **Tests:** ${testsResult}
          
          ${validationResult === 'success' && testsResult === 'success' 
            ? '### ‚ú® All checks passed! Ready for review.' 
            : '### ‚ö†Ô∏è Some checks failed. Please review the details above.'}
          
          ---
          *This comment was automatically generated*`;
          
          github.rest.issues.createComment({
            issue_number: prNumber,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: message
          });
