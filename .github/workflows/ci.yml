name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true

permissions:
  contents: read
  checks: write
  pull-requests: write
  security-events: write # Required for SARIF upload

jobs:
  build:
    name: ðŸ”¨ Build & Validate
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ðŸ“¦ Restore dependencies
        run: dotnet restore
        working-directory: ./Rest

      - name: ðŸ”¨ Build
        run: dotnet build --no-restore --configuration Release
        working-directory: ./Rest

      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            Rest/bin/Release/
            Rest.Tests/bin/Release/
          retention-days: 1

  unit-tests:
    name: ðŸ§ª Unit Tests
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ðŸ§ª Run Unit Tests
        run: |
          dotnet test Rest.Tests/Rest.Tests.csproj \
            --filter "FullyQualifiedName~UnitTests" \
            --configuration Release \
            --logger "trx;LogFileName=unit-test-results.trx" \
            --logger "console;verbosity=normal" \
            --results-directory ./TestResults \
            --collect:"XPlat Code Coverage" \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover

      - name: ðŸ“¤ Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results
          path: TestResults/**/*
          retention-days: 30

      - name: ðŸ“ˆ Codecov
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: TestResults/**/coverage.opencover.xml
          flags: unittests
          fail_ci_if_error: false

  integration-tests:
    name: ðŸ”Œ Integration Tests
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ðŸ§ª Run Integration Tests
        run: |
          dotnet test Rest.Tests/Rest.Tests.csproj \
            --filter "FullyQualifiedName~IntegrationTests" \
            --configuration Release \
            --logger "trx;LogFileName=integration-test-results.trx" \
            --logger "console;verbosity=normal" \
            --results-directory ./TestResults \
            --collect:"XPlat Code Coverage" \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover

      - name: ðŸ“¤ Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: TestResults/**/*
          retention-days: 30

      - name: ðŸ“ˆ Codecov
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: TestResults/**/coverage.opencover.xml
          flags: integrationtests
          fail_ci_if_error: false

  security-tests:
    name: ðŸ”’ Security Tests
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ðŸ”’ Run Security Tests
        run: |
          dotnet test Rest.Tests/Rest.Tests.csproj \
            --filter "FullyQualifiedName~SecurityTests" \
            --configuration Release \
            --logger "trx;LogFileName=security-test-results.trx" \
            --results-directory ./TestResults

      - name: ðŸ“¤ Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-test-results
          path: TestResults/**/*
          retention-days: 30

  ci-success:
    name: âœ… CI Success
    needs: [unit-tests, integration-tests, security-tests]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - run: echo "All critical tests passed!"
