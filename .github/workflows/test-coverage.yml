name: ğŸ“Š Test Coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  coverage:
    name: Generate Coverage
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: ğŸ› ï¸ Install ReportGenerator
        run: dotnet tool install -g dotnet-reportgenerator-globaltool

      - name: ğŸ§ª Run Tests & Collect Coverage
        run: |
          dotnet test Rest.Tests/Rest.Tests.csproj \
            --configuration Release \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover

      - name: ğŸ“„ Generate HTML Report
        run: |
          reportgenerator \
            -reports:"TestResults/**/coverage.opencover.xml" \
            -targetdir:"coverage-report" \
            -reporttypes:"Html;JsonSummary;Badges"

      - name: ğŸ“¤ Upload Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage-report/
          retention-days: 30

      - name: ğŸ“ˆ Upload to Codecov
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          directory: ./TestResults
          files: "**/*.opencover.xml"
          fail_ci_if_error: false
